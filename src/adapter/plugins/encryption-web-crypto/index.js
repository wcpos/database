import{hasEncryption as e,newRxError as a,newRxTypeError as t,b64DecodeUnicode as r,b64EncodeUnicode as s,wrapRxStorageInstance as n}from"rxdb";import{clone as c,ensureNotFalsy as o,flatClone as i,getProperty as m,setProperty as d}from"rxdb/plugins/utils";import{decryptString as p,encryptString as h,getCryptoKey as l,getDefaultSeed as w,MINIMUM_PASSWORD_LENGTH as f}from"./helpers";export*from"./helpers";export function wrappedKeyEncryptionWebCryptoStorage(t){var f,y,g=t.salt?t.salt:w();return Object.assign({},t.storage,{async createStorageInstance(w){if(void 0!==w.password&&v(w.password),!e(w.schema))return await t.storage.createStorageInstance(w);if(!w.password)throw a("EN3",{database:w.databaseName,collection:w.collectionName,schema:w.schema});var b=c(w.schema);delete b.encrypted,b.attachments&&(b.attachments.encrypted=!1);var T=w.password,E=T.password,N=T.algorithm,[P,S]=await Promise.all([l(E,N,g),t.storage.createStorageInstance(Object.assign({},w,{schema:b}))]);function O(){return f||(f={decToEnc:new Map,encToDec:new Map},y=setTimeout((()=>{f=void 0}),2e4)),f}function _(e){var a=O().decToEnc.get(e);return a||(a=h(P,N,e),O().decToEnc.set(e,a),a.then((()=>a=>O().encToDec.set(a,Promise.resolve(e))))),a}function j(e,a){if(!a)return p(P,N,e);var t=O().encToDec.get(e);return t||(t=p(P,N,e),O().encToDec.set(e,t),t.then((a=>O().decToEnc.set(a,Promise.resolve(e))))),t}async function x(e){if(e=u(e),await Promise.all(o(w.schema.encrypted).map((async a=>{var t=m(e,a);if(void 0!==t){var r=JSON.stringify(t),s=await _(r);d(e,a,s)}}))),w.schema.attachments&&w.schema.attachments.encrypted){var a={};await Promise.all(Object.entries(e._attachments).map((async([e,t])=>{var r=i(t);if(r.data){var n=r.data,c=await _(n);r.data=s(c)}a[e]=r}))),e._attachments=a}return e}async function D(e){return e=u(e),await Promise.all(o(w.schema.encrypted).map((async a=>{var t=m(e,a);if(void 0!==t){var r=await j(t,!0),s=JSON.parse(r);d(e,a,s)}}))),e}async function I(e){return w.schema.attachments&&w.schema.attachments.encrypted?await j(r(e),!1):e}var J=n(S,x,D,I),M=J.close.bind(J);return J.close=()=>(y&&clearTimeout(y),M()),J}})}function u(e){var a=e._attachments;return delete(e=i(e))._attachments,(e=c(e))._attachments=a,e}function v(e){if("object"!=typeof e)throw t("EN4",{password:e});if(!e.algorithm||!e.password)throw t("EN1",{password:e});if(e.password.length<f)throw a("EN2",{minPassLength:f,password:e})}