import{hasEncryption as a,newRxError as t,newRxTypeError as e,b64DecodeUnicode as r,b64EncodeUnicode as n,wrapRxStorageInstance as s}from"rxdb";import{clone as c,ensureNotFalsy as o,flatClone as i,getProperty as m,setProperty as d}from"rxdb/plugins/utils";import{decryptString as p,encryptString as h,getCryptoKey as w,getDefaultSeed as f,MINIMUM_PASSWORD_LENGTH as l}from"./helpers";export*from"./helpers";export function wrappedKeyEncryptionWebCryptoStorage(e){var l,y,g=e.salt?e.salt:f();return Object.assign({},e.storage,{async createStorageInstance(f){if(void 0!==f.password&&v(f.password),!a(f.schema))return await e.storage.createStorageInstance(f);if(!f.password)throw t("EN3",{database:f.databaseName,collection:f.collectionName,schema:f.schema});var b=c(f.schema);delete b.encrypted,b.attachments&&(b.attachments.encrypted=!1);var T=f.password,E=T.password,N=T.algorithm,[S,O]=await Promise.all([w(E,N,g),e.storage.createStorageInstance(Object.assign({},f,{schema:b}))]);function P(){return l||(l={decToEnc:new Map,encToDec:new Map},y=setTimeout((()=>{l=void 0}),2e4)),l}async function _(a){var t=P().decToEnc.get(a);if(t)return t;var e=await h(S,N,a);return P().encToDec.set(e,a),P().decToEnc.set(a,e),e}async function j(a){var t=P().encToDec.get(a);if(t)return t;var e=await p(S,N,a);return P().encToDec.set(a,e),P().decToEnc.set(e,a),e}async function x(a){if(a=u(a),await Promise.all(o(f.schema.encrypted).map((async t=>{var e=m(a,t);if(void 0!==e){var r=JSON.stringify(e),n=await _(r);d(a,t,n)}}))),f.schema.attachments&&f.schema.attachments.encrypted){var t={};await Promise.all(Object.entries(a._attachments).map((async([a,e])=>{var r=i(e);if(r.data){var s=r.data,c=await _(s);r.data=n(c)}t[a]=r}))),a._attachments=t}return a}async function D(a){return a=u(a),await Promise.all(o(f.schema.encrypted).map((async t=>{var e=m(a,t);if(void 0!==e){var r=await j(e),n=JSON.parse(r);d(a,t,n)}}))),a}async function I(a){return f.schema.attachments&&f.schema.attachments.encrypted?await j(r(a)):a}var J=s(O,x,D,I),M=J.close.bind(J);return J.close=()=>(y&&clearTimeout(y),M()),J}})}function u(a){var t=a._attachments;return delete(a=i(a))._attachments,(a=c(a))._attachments=t,a}function v(a){if("object"!=typeof a)throw e("EN4",{password:a});if(!a.algorithm||!a.password)throw e("EN1",{password:a});if(a.password.length<l)throw t("EN2",{minPassLength:l,password:a})}