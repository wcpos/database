var e=this&&this.__awaiter||function(e,t,n,r){function i(e){return e instanceof n?e:new n((function(t){t(e)}))}return new(n||(n=Promise))((function(n,o){function s(e){try{c(r.next(e))}catch(e){o(e)}}function a(e){try{c(r.throw(e))}catch(e){o(e)}}function c(e){e.done?n(e.value):i(e.value).then(s,a)}c((r=r.apply(e,t||[])).next())}))},t=this&&this.__generator||function(e,t){var n,r,i,o,s={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return o={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function a(e){return function(t){return c([e,t])}}function c(a){if(n)throw new TypeError("Generator is already executing.");for(;o&&(o=0,a[0]&&(s=0)),s;)try{if(n=1,r&&(i=2&a[0]?r.return:a[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,a[1])).done)return i;switch(r=0,i&&(a=[2&a[0],i.value]),a[0]){case 0:case 1:i=a;break;case 4:return s.label++,{value:a[1],done:!1};case 5:s.label++,r=a[1],a=[0];continue;case 7:a=s.ops.pop(),s.trys.pop();continue;default:if(!(i=s.trys,(i=i.length>0&&i[i.length-1])||6!==a[0]&&2!==a[0])){s=0;continue}if(3===a[0]&&(!i||a[1]>i[0]&&a[1]<i[3])){s.label=a[1];break}if(6===a[0]&&s.label<i[1]){s.label=i[1],i=a;break}if(i&&s.label<i[2]){s.label=i[2],s.ops.push(a);break}i[2]&&s.ops.pop(),s.trys.pop();continue}a=t.call(e,s)}catch(e){a=[6,e],r=0}finally{n=i=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}};import{getStartIndexStringFromLowerBound as n,getStartIndexStringFromUpperBound as r,lastOfArray as i}from"rxdb";import{RxStorageIndexedDBStatics as o,TRANSACTION_SETTINGS as s}from"./indexeddb-helpers";import{getIndexName as a,stripCustomIndexesFromDocData as c}from"./indexeddb-index-helpers";export function queryIndexedDB(i,c){return e(this,void 0,void 0,(function(){var e,u,l,d,f,h,m,y,p,v,b,g,x,w,S,B,I,P,K,D,_,E,k;return t(this,(function(t){switch(t.label){case 0:return e=c.queryPlan,u=c.query,l=u.skip?u.skip:0,d=u.limit?u.limit:1/0,f=l+d,h=i.internals.storeNames.documentStore,m=i.settings.batchSize?i.settings.batchSize:50,y=!1,e.selectorSatisfiedByIndex||(y=o.getQueryMatcher(i.schema,c)),p=e.index,v=!e.sortFieldsSameAsIndexFields,b=["_deleted"].concat(p),g=e.startKeys,g=[!1].concat(g),x=n(i.schema,b,g,e.inclusiveStart),w=e.endKeys,w=[!1].concat(w),S=r(i.schema,b,w,e.inclusiveEnd),B=[],[4,i.internals.state.creationPromise];case 1:return I=t.sent(),P=I.transaction([h],"readonly",s),K=P.objectStore(h),1===p.length&&p[0]===i.primaryPath?(_=a(["_deleted",i.primaryPath]),D=K.index(_)):(_=a(b),D=K.index(_)),E=!1,[4,runBatchedCursor(i,e,D,m,x,S,b,(function(e){return e.forEach((function(e){E||y&&!y(e)||B.push(e),v||B.length!==f||(E=!0)})),!E}))];case 2:return t.sent(),P.commit&&P.commit(),v&&(k=o.getSortComparator(i.schema,c),B=B.sort(k)),[2,{documents:B=B.slice(l,f)}]}}))}))}export function runBatchedCursor(n,r,o,s,u,l,d,f){return e(this,void 0,void 0,(function(){var e,h,m,y,p,v,b,g,x;return t(this,(function(w){switch(w.label){case 0:if(e=n.settings.IDBKeyRange?n.settings.IDBKeyRange:IDBKeyRange,h=a(d),m=n.internals.getIndexableStringByIndexName[h],"function"!=typeof o.getAll||1===s)return[3,4];y=!0,p=!1,b=function(){var n,a;return t(this,(function(t){switch(t.label){case 0:return v&&(u=m(v)),n=e.bound(u,l,!y||!r.inclusiveStart,!r.inclusiveEnd),y=!1,a=o.getAll(n,s),[4,new Promise((function(e,t){a.onerror=function(e){return t(e)},a.onsuccess=function(t){var n=t.target.result;(v=i(n),0!==n.length)&&(!1===f(n.map((function(e){return c(e)})))&&(p=!0));n.length<s&&(p=!0),e()}}))];case 1:return t.sent(),[2]}}))},w.label=1;case 1:return!1!==p?[3,3]:[5,b()];case 2:return w.sent(),[3,1];case 3:return[3,6];case 4:return g=e.bound(u,l,!r.inclusiveStart,!r.inclusiveEnd),x=o.openCursor(g),[4,new Promise((function(e){x.onsuccess=function(t){var n=t.target.result;if(n){var r=n.value;f([c(r)])?n.continue():e()}else e()}}))];case 5:w.sent(),w.label=6;case 6:return[2]}}))}))}export function countIndexedDB(i,o){return e(this,void 0,void 0,(function(){var e,c,u,l,d,f,h,m,y,p,v,b,g,x,w,S;return t(this,(function(t){switch(t.label){case 0:return e=o.queryPlan,o.query,c=i.internals.storeNames.documentStore,u=e.index,l=["_deleted"].concat(u),d=e.startKeys,d=[!1].concat(d),f=n(i.schema,l,d,e.inclusiveStart),h=e.endKeys,h=[!1].concat(h),m=r(i.schema,l,h,e.inclusiveEnd),[4,i.internals.state.creationPromise];case 1:return y=t.sent(),p=y.transaction([c],"readonly",s),v=p.objectStore(c),1===u.length&&u[0]===i.primaryPath?(g=a(["_deleted",i.primaryPath]),b=v.index(g)):(g=a(l),b=v.index(g)),x=i.settings.IDBKeyRange?i.settings.IDBKeyRange:IDBKeyRange,w=x.bound(f,m,!e.inclusiveStart,!e.inclusiveEnd),S=b.count(w),[4,new Promise((function(e,t){S.onsuccess=function(){var t=S.result;e(t)},S.onerror=function(e){return t(e)}}))];case 2:return[2,{count:t.sent(),mode:"fast"}]}}))}))}