var t=this&&this.__awaiter||function(t,e,n,r){function s(t){return t instanceof n?t:new n((function(e){e(t)}))}return new(n||(n=Promise))((function(n,a){function i(t){try{c(r.next(t))}catch(t){a(t)}}function o(t){try{c(r.throw(t))}catch(t){a(t)}}function c(t){t.done?n(t.value):s(t.value).then(i,o)}c((r=r.apply(t,e||[])).next())}))},e=this&&this.__generator||function(t,e){var n,r,s,a,i={label:0,sent:function(){if(1&s[0])throw s[1];return s[1]},trys:[],ops:[]};return a={next:o(0),throw:o(1),return:o(2)},"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function o(t){return function(e){return c([t,e])}}function c(a){if(n)throw new TypeError("Generator is already executing.");for(;i;)try{if(n=1,r&&(s=2&a[0]?r.return:a[0]?r.throw||((s=r.return)&&s.call(r),0):r.next)&&!(s=s.call(r,a[1])).done)return s;switch(r=0,s&&(a=[2&a[0],s.value]),a[0]){case 0:case 1:s=a;break;case 4:return i.label++,{value:a[1],done:!1};case 5:i.label++,r=a[1],a=[0];continue;case 7:a=i.ops.pop(),i.trys.pop();continue;default:if(!(s=i.trys,(s=s.length>0&&s[s.length-1])||6!==a[0]&&2!==a[0])){i=0;continue}if(3===a[0]&&(!s||a[1]>s[0]&&a[1]<s[3])){i.label=a[1];break}if(6===a[0]&&i.label<s[1]){i.label=s[1],s=a;break}if(s&&i.label<s[2]){i.label=s[2],i.ops.push(a);break}s[2]&&i.ops.pop(),i.trys.pop();continue}a=e.call(t,i)}catch(t){a=[6,t],r=0}finally{n=s=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}};import{addRxStorageMultiInstanceSupport as n,categorizeBulkWriteRows as r,getNewestOfDocumentStates as s,getPrimaryFieldOfPrimaryKey as a,getStartIndexStringFromLowerBound as i,getStartIndexStringFromUpperBound as o,lastOfArray as c,now as u,PROMISE_RESOLVE_VOID as h}from"rxdb";import{Subject as m}from"rxjs";import{attachmentObjectId as l,closeIndexedDBDatabase as d,getIndexedDBState as f,getStoreNamesForStorageInstance as p,RX_STORAGE_NAME_INDEXEDDB as v,TRANSACTION_SETTINGS as y}from"./indexeddb-helpers";import{CLEANUP_INDEX as b,enhanceDocDataWithCustomIndexes as g,getIndexableStringByIndexName as w,getIndexName as P,stripCustomIndexesFromDocData as S}from"./indexeddb-index-helpers";import{queryIndexedDB as I}from"./indexeddb-query";var N=u(),x=function(){function n(t,e,n,r,s,i,o){this.storage=t,this.databaseName=e,this.collectionName=n,this.schema=r,this.internals=s,this.options=i,this.settings=o,this.changes$=new m,this.instanceId=N++,this.closed=!1,this.primaryPath=a(this.schema.primaryKey)}return n.prototype.bulkWrite=function(n,a){return t(this,void 0,void 0,(function(){var t,i,o,c,u,h,m,d,f=this;return e(this,(function(e){switch(e.label){case 0:return[4,this.internals.state.creationPromise];case 1:return e.sent(),t={success:{},error:{}},[4,this.internals.state.creationPromise];case 2:return i=e.sent(),o=[this.internals.storeNames.documentStore],this.schema.attachments&&o.push(this.internals.storeNames.attachmentsStore),D(this),c=i.transaction(o,"readwrite",y),u=c.objectStore(this.internals.storeNames.documentStore),h=new Map,[4,new Promise((function(t,e){var r=n.length;n.forEach((function(n){var s=n.document[f.primaryPath],a=u.get(s);a.onerror=function(t){return e(t)},a.onsuccess=function(e){var n=a.result;n&&h.set(s,S(n)),0===(r-=1)&&t()}}))}))];case 3:return e.sent(),(m=r(this,this.primaryPath,h,n,a)).errors.forEach((function(e){t.error[e.documentId]=e})),m.bulkInsertDocs.forEach((function(e){var n=g(f.internals.getIndexableStringByIndexName,e.document);u.put(n);var r=e.document[f.primaryPath];t.success[r]=e.document})),m.bulkUpdateDocs.forEach((function(e){var n=g(f.internals.getIndexableStringByIndexName,e.document);u.put(n);var r=e.document[f.primaryPath];t.success[r]=e.document})),this.schema.attachments&&(d=c.objectStore(this.internals.storeNames.attachmentsStore),m.attachmentsAdd.forEach((function(t){d.put({docIdWithAttachmentId:l(t.documentId,t.attachmentId),digest:t.attachmentData.digest,length:t.attachmentData.length,type:t.attachmentData.type,data:t.attachmentData.data})})),m.attachmentsUpdate.forEach((function(t){d.put({docIdWithAttachmentId:l(t.documentId,t.attachmentId),digest:t.attachmentData.digest,length:t.attachmentData.length,type:t.attachmentData.type,data:t.attachmentData.data})})),m.attachmentsRemove.forEach((function(t){d.delete(l(t.documentId,t.attachmentId))}))),c.commit&&c.commit(),[2,new Promise((function(e,n){c.onerror=function(t){n(t)},c.oncomplete=function(n){if(m.eventBulk.events.length>0){var r=s(f.primaryPath,Object.values(t.success));m.eventBulk.checkpoint={id:r[f.primaryPath],lwt:r._meta.lwt},f.changes$.next(m.eventBulk)}e(t)}}))]}}))}))},n.prototype.findDocumentsById=function(n,r){return t(this,void 0,void 0,(function(){var t,s,a,i;return e(this,(function(e){switch(e.label){case 0:return[4,this.internals.state.creationPromise];case 1:return e.sent(),[4,this.internals.state.creationPromise];case 2:return t=e.sent(),D(this),s=t.transaction([this.internals.storeNames.documentStore],"readonly",y),a=s.objectStore(this.internals.storeNames.documentStore),i={},[4,Promise.all(n.map((function(t){return new Promise((function(e){var n=a.get(t);n.onsuccess=function(s){var a=n.result;!a||a._deleted&&!r||(i[t]=S(a)),e()}}))})))];case 3:return e.sent(),s.commit&&s.commit(),[2,i]}}))}))},n.prototype.query=function(n){return t(this,void 0,void 0,(function(){return e(this,(function(t){switch(t.label){case 0:return[4,this.internals.state.creationPromise];case 1:return t.sent(),D(this),[2,I(this,n)]}}))}))},n.prototype.getChangedDocumentsSince=function(n,r){return t(this,void 0,void 0,(function(){var t,s,a,i,o,u,h,m,l,d,f,p,v,b;return e(this,(function(e){switch(e.label){case 0:return[4,this.internals.state.creationPromise];case 1:return e.sent(),t=this.settings.IDBKeyRange,[4,this.internals.state.creationPromise];case 2:return s=e.sent(),D(this),a=s.transaction([this.internals.storeNames.documentStore],"readonly",y),i=a.objectStore(this.internals.storeNames.documentStore),o=["_meta.lwt",this.primaryPath],u=P(o),h=i.index(u),m="",r&&((b={})[this.primaryPath]=r.id,b._meta={lwt:r.lwt},l=b,d=this.internals.getIndexableStringByIndexName[u],m=d(l)),f=t.lowerBound(m,!!r),[4,new Promise((function(t,e){var r=h.getAll(f,n);r.onerror=function(t){return e(t)},r.onsuccess=function(e){t(e.target.result)}}))];case 3:return p=e.sent(),a.commit&&a.commit(),v=c(p),[2,{documents:p.map((function(t){return S(t)})),checkpoint:v?{id:v[this.primaryPath],lwt:v._meta.lwt}:r||{id:"",lwt:0}}]}}))}))},n.prototype.changeStream=function(){return this.changes$.asObservable()},n.prototype.cleanup=function(n){return t(this,void 0,void 0,(function(){var t,r,s,a,c,h,m,l,d,f,p,v,g,w=this;return e(this,(function(e){switch(e.label){case 0:return[4,this.internals.state.creationPromise];case 1:return e.sent(),t=this.settings.IDBKeyRange,[4,this.internals.state.creationPromise];case 2:return r=e.sent(),D(this),s=r.transaction([this.internals.storeNames.documentStore],"readwrite",y),a=s.objectStore(this.internals.storeNames.documentStore),c=this.settings.batchSize,h=u()-n,l=P(m=b),d=a.index(l),f=i(this.schema,m,[!0,1]),p=o(this.schema,m,[!0,h]),v=t.bound(f,p,!0,!0),[4,new Promise((function(t,e){var n=d.getAll(v,c);n.onerror=function(t){return e(t)},n.onsuccess=function(e){t(e.target.result)}}))];case 3:return g=e.sent(),[4,Promise.all(g.map((function(t){return new Promise((function(e,n){var r=t[w.primaryPath],s=a.delete(r);s.onerror=function(t){return n(t)},s.onsuccess=function(){return e()}}))})))];case 4:return e.sent(),s.commit&&s.commit(),[2,g.length<c]}}))}))},n.prototype.remove=function(){return t(this,void 0,void 0,(function(){var t,n,r;return e(this,(function(e){switch(e.label){case 0:return[4,this.internals.state.creationPromise];case 1:return e.sent(),[4,this.internals.state.creationPromise];case 2:return t=e.sent(),D(this),n=t.transaction([this.internals.storeNames.documentStore],"readwrite",y),r=n.objectStore(this.internals.storeNames.documentStore),[4,Promise.all([r].map((function(t){return new Promise((function(t,e){var n=r.clear();n.onerror=function(t){return e(t)},n.onsuccess=function(e){t()}}))})))];case 3:return e.sent(),n.commit&&n.commit(),[2,this.close()]}}))}))},n.prototype.getAttachmentData=function(n,r){return t(this,void 0,void 0,(function(){var t,s,a,i;return e(this,(function(e){switch(e.label){case 0:return[4,this.internals.state.creationPromise];case 1:return e.sent(),[4,this.internals.state.creationPromise];case 2:return t=e.sent(),D(this),s=t.transaction([this.internals.storeNames.attachmentsStore],"readonly",y),a=s.objectStore(this.internals.storeNames.attachmentsStore),i=l(n,r),[2,new Promise((function(t,e){var s=a.get(i);s.onsuccess=function(){var a=s.result;a?t(a.data):e("attachment missing documentId: "+n+" attachmentId: "+r)}}))]}}))}))},n.prototype.close=function(){return t(this,void 0,void 0,(function(){return e(this,(function(t){switch(t.label){case 0:return[4,this.internals.state.creationPromise];case 1:return t.sent(),D(this),this.closed=!0,this.changes$.complete(),[2,d(this.internals.state)]}}))}))},n.prototype.conflictResultionTasks=function(){return(new m).asObservable()},n.prototype.resolveConflictResultionTask=function(t){return h},n}();export{x as RxStorageInstanceIndexedDB};export function createIndexedDBStorageInstance(r,s,a){return t(this,void 0,void 0,(function(){var t,i,o;return e(this,(function(e){switch(e.label){case 0:return[4,f(r,a,s.databaseName,[{collectionName:s.collectionName,schema:s.schema}])];case 1:return[4,(t=e.sent()).creationPromise];case 2:return e.sent(),i={state:t,storeNames:p(s.collectionName,s.schema),getIndexableStringByIndexName:w(s.schema)},o=new x(r,s.databaseName,s.collectionName,s.schema,i,s.options,a),n(v,s,o),[2,o]}}))}))}function D(t){if(t.closed)throw new Error("RxStorageInstanceIndexedDB is closed "+t.databaseName+"-"+t.collectionName)}