var t=this&&this.__awaiter||function(t,e,n,r){function a(t){return t instanceof n?t:new n((function(e){e(t)}))}return new(n||(n=Promise))((function(n,o){function s(t){try{c(r.next(t))}catch(t){o(t)}}function i(t){try{c(r.throw(t))}catch(t){o(t)}}function c(t){t.done?n(t.value):a(t.value).then(s,i)}c((r=r.apply(t,e||[])).next())}))},e=this&&this.__generator||function(t,e){var n,r,a,o,s={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]};return o={next:i(0),throw:i(1),return:i(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function i(t){return function(e){return c([t,e])}}function c(i){if(n)throw new TypeError("Generator is already executing.");for(;o&&(o=0,i[0]&&(s=0)),s;)try{if(n=1,r&&(a=2&i[0]?r.return:i[0]?r.throw||((a=r.return)&&a.call(r),0):r.next)&&!(a=a.call(r,i[1])).done)return a;switch(r=0,a&&(i=[2&i[0],a.value]),i[0]){case 0:case 1:a=i;break;case 4:return s.label++,{value:i[1],done:!1};case 5:s.label++,r=i[1],i=[0];continue;case 7:i=s.ops.pop(),s.trys.pop();continue;default:if(!(a=s.trys,(a=a.length>0&&a[a.length-1])||6!==i[0]&&2!==i[0])){s=0;continue}if(3===i[0]&&(!a||i[1]>a[0]&&i[1]<a[3])){s.label=i[1];break}if(6===i[0]&&s.label<a[1]){s.label=a[1],a=i;break}if(a&&s.label<a[2]){s.label=a[2],s.ops.push(i);break}a[2]&&s.ops.pop(),s.trys.pop();continue}i=e.call(t,s)}catch(t){i=[6,t],r=0}finally{n=a=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}},n=this&&this.__read||function(t,e){var n="function"==typeof Symbol&&t[Symbol.iterator];if(!n)return t;var r,a,o=n.call(t),s=[];try{for(;(void 0===e||e-- >0)&&!(r=o.next()).done;)s.push(r.value)}catch(t){a={error:t}}finally{try{r&&!r.done&&(n=o.return)&&n.call(o)}finally{if(a)throw a.error}}return s};import{categorizeBulkWriteRows as r,ensureRxStorageInstanceParamsAreCorrect as a,getPrimaryFieldOfPrimaryKey as o,lastOfArray as s,now as i,PROMISE_RESOLVE_TRUE as c,PROMISE_RESOLVE_VOID as u,newRxError as l}from"rxdb";import{RxStorageDexieStatics as h}from"rxdb/plugins/dexie";import{Subject as f}from"rxjs";export var RX_STORAGE_NAME_LOCALSTORAGE="localstorage";var d=function(){function t(t){this.settings=t,this.name=RX_STORAGE_NAME_LOCALSTORAGE,this.statics=h}return t.prototype.createStorageInstance=function(t){return a(t),createLocalstorageStorageInstance(this,t,Object.assign({},this.settings,t.options))},t}();export{d as RxStorageLocalstorage};export function getRxStorageLocalstorage(t){return void 0===t&&(t={}),new d(t)}var g=new f,m=!1;export function getStorageEventStream(){return m||(m=!0,window.addEventListener("storage",(function(t){t.key&&g.next({key:t.key,newValue:t.newValue})}))),g.asObservable()}var p=function(){function a(t,e,n,r,a,s,i,c){var u=this;this.storage=t,this.databaseName=e,this.collectionName=n,this.schema=r,this.internals=a,this.options=s,this.settings=i,this.databaseInstanceToken=c,this.changes$=new f,this.closed=!1,this.primaryPath=o(this.schema.primaryKey),this.storageKey="rx-storage-localstorage-"+this.databaseName+"--"+this.collectionName+"--"+this.schema.version,this.changestreamStorageKey="rx-storage-localstorage-changestream-"+this.databaseName+"--"+this.collectionName+"--"+this.schema.version,this.changeStreamSub=getStorageEventStream().subscribe((function(t){if(t.key===u.changestreamStorageKey&&t.newValue&&t.databaseInstanceToken!==u.databaseInstanceToken){var e=JSON.parse(t.newValue);e.databaseInstanceToken!==u.databaseInstanceToken&&(u.changes$.next(e.eventBulk),u.internals.docsById=getStorageState(u.storageKey))}}))}return a.prototype.bulkWrite=function(n,a){return t(this,void 0,void 0,(function(){var t,o,s,i,c,u=this;return e(this,(function(e){return t={success:{},error:{}},o=r(this,this.primaryPath,this.internals.docsById,n,a),t.error=o.errors,s=!1,[o.bulkInsertDocs,o.bulkUpdateDocs].forEach((function(e){e.forEach((function(e){s=!0;var n=e.document[u.primaryPath];u.internals.docsById[n]=e.document,t.success[n]=e.document}))})),s&&localstoragePersist(this),o.eventBulk.events.length>0&&(i={databaseInstanceToken:this.databaseInstanceToken,eventBulk:o.eventBulk},c=JSON.stringify(i),localStorage.setItem(this.changestreamStorageKey,c),g.next({key:this.changestreamStorageKey,newValue:c,databaseInstanceToken:this.databaseInstanceToken})),[2,t]}))}))},a.prototype.findDocumentsById=function(n,r){return t(this,void 0,void 0,(function(){var t,a;return e(this,(function(e){return t={},a=this.internals.docsById,n.forEach((function(e){var n=a[e];n&&(!r&&n._deleted||(t[e]=n))})),[2,t]}))}))},a.prototype.query=function(n){return t(this,void 0,void 0,(function(){var t,r,a,o,s,i,c,u;return e(this,(function(e){return t=n.query,r=t.skip?t.skip:0,a=t.limit?t.limit:1/0,o=r+a,s=this.storage.statics.getQueryMatcher(this.schema,n),i=Object.values(this.internals.docsById).filter((function(t){return s(t)})),c=this.storage.statics.getSortComparator(this.schema,n),u=i.sort(c),[2,{documents:u.slice(r,o)}]}))}))},a.prototype.count=function(n){return t(this,void 0,void 0,(function(){return e(this,(function(t){switch(t.label){case 0:return[4,this.query(n)];case 1:return[2,{count:t.sent().documents.length,mode:"fast"}]}}))}))},a.prototype.getChangedDocumentsSince=function(n,r){return t(this,void 0,void 0,(function(){var t,a,o,i=this;return e(this,(function(e){return t=Object.values(this.internals.docsById),r&&(t=t.filter((function(t){return t._meta.lwt>r.lwt||t._meta.lwt===r.lwt&&t[i.primaryPath]>r.id}))),a=t.slice(0,n),o=s(a),[2,{documents:a,checkpoint:o?{id:o[this.primaryPath],lwt:o._meta.lwt}:r||{id:"",lwt:0}}]}))}))},a.prototype.changeStream=function(){return this.changes$.asObservable()},a.prototype.cleanup=function(t){var e=this,r=i()-t,a=!1;return Object.entries(this.internals.docsById).forEach((function(t){var o=n(t,2),s=o[0],i=o[1];i._deleted&&(i._meta.lwt>r||(delete e.internals.docsById[s],a=!0))})),a&&localstoragePersist(this),c},a.prototype.getAttachmentData=function(t,e){throw l("SNH")},a.prototype.remove=function(){return localStorage.removeItem(this.storageKey),localStorage.removeItem(this.changestreamStorageKey),u},a.prototype.close=function(){return this.closed?Promise.reject(l("SNH",{database:this.databaseName,collection:this.collectionName})):(this.closed=!0,this.changes$.complete(),this.changeStreamSub.unsubscribe(),localStorage.removeItem(this.changestreamStorageKey),u)},a.prototype.conflictResultionTasks=function(){return(new f).asObservable()},a.prototype.resolveConflictResultionTask=function(t){return u},a}();export{p as RxStorageInstanceLocalstorage};export function localstoragePersist(t){localStorage.setItem(t.storageKey,JSON.stringify(t.internals.docsById))}export function createLocalstorageStorageInstance(n,r,a){return t(this,void 0,void 0,(function(){var t,o;return e(this,(function(e){return t={docsById:{}},o=new p(n,r.databaseName,r.collectionName,r.schema,t,r.options,a,r.databaseInstanceToken),t.docsById=getStorageState(o.storageKey),[2,o]}))}))}export function getStorageState(t){var e=localStorage.getItem(t);return e?JSON.parse(e):{}}