var e=this&&this.__awaiter||function(e,t,n,r){function s(e){return e instanceof n?e:new n((function(t){t(e)}))}return new(n||(n=Promise))((function(n,a){function i(e){try{c(r.next(e))}catch(e){a(e)}}function o(e){try{c(r.throw(e))}catch(e){a(e)}}function c(e){e.done?n(e.value):s(e.value).then(i,o)}c((r=r.apply(e,t||[])).next())}))},t=this&&this.__generator||function(e,t){var n,r,s,a,i={label:0,sent:function(){if(1&s[0])throw s[1];return s[1]},trys:[],ops:[]};return a={next:o(0),throw:o(1),return:o(2)},"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function o(e){return function(t){return c([e,t])}}function c(o){if(n)throw new TypeError("Generator is already executing.");for(;a&&(a=0,o[0]&&(i=0)),i;)try{if(n=1,r&&(s=2&o[0]?r.return:o[0]?r.throw||((s=r.return)&&s.call(r),0):r.next)&&!(s=s.call(r,o[1])).done)return s;switch(r=0,s&&(o=[2&o[0],s.value]),o[0]){case 0:case 1:s=o;break;case 4:return i.label++,{value:o[1],done:!1};case 5:i.label++,r=o[1],o=[0];continue;case 7:o=i.ops.pop(),i.trys.pop();continue;default:if(!(s=i.trys,(s=s.length>0&&s[s.length-1])||6!==o[0]&&2!==o[0])){i=0;continue}if(3===o[0]&&(!s||o[1]>s[0]&&o[1]<s[3])){i.label=o[1];break}if(6===o[0]&&i.label<s[1]){i.label=s[1],s=o;break}if(s&&i.label<s[2]){i.label=s[2],i.ops.push(o);break}s[2]&&i.ops.pop(),i.trys.pop();continue}o=t.call(e,i)}catch(e){o=[6,e],r=0}finally{n=s=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}},n=this&&this.__read||function(e,t){var n="function"==typeof Symbol&&e[Symbol.iterator];if(!n)return e;var r,s,a=n.call(e),i=[];try{for(;(void 0===t||t-- >0)&&!(r=a.next()).done;)i.push(r.value)}catch(e){s={error:e}}finally{try{r&&!r.done&&(n=a.return)&&n.call(a)}finally{if(s)throw s.error}}return i};import{replicateRxStorageInstance as r,randomCouchString as s,awaitRxStorageReplicationFirstInSync as a,RX_REPLICATION_META_INSTANCE_SCHEMA as i,STORAGE_TOKEN_DOCUMENT_ID as o,flatClone as c,rxStorageInstanceToReplicationHandler as u,ensureRxStorageInstanceParamsAreCorrect as l,INTERNAL_STORE_SCHEMA_TITLE as f,defaultHashFunction as h}from"rxdb";import{RX_LOCAL_DOCUMENT_SCHEMA as m}from"rxdb/plugins/local-documents";import{getRxStorageMemory as p}from"rxdb/plugins/memory";import{MemorySyncedRxStorageInstance as d}from"./memory-synced-storage-instance";import{filter as y,firstValueFrom as b,Subject as g}from"rxjs";var v=p(),w=function(){function p(e){var t=this;this.settings=e,this.name="memory-synced",this.statics=Object.assign({},v.statics,{prepareQuery:function(e,n){return e.title===f?t.settings.storage.statics.prepareQuery(e,n):v.statics.prepareQuery(e,n)}}),this.firstInstanceTokens={}}return p.prototype.createStorageInstance=function(p){return e(this,void 0,void 0,(function(){var w,I,k,S,x,T,N,P,z,_,j,B,O,Q,E,H=this;return t(this,(function(W){switch(W.label){case 0:if(l(p),w=p.databaseInstanceToken,I=this,p.schema.attachments)throw new Error("The memory-synced plugin does not support attachments");return p.schema.title!==f?[3,2]:[4,this.settings.storage.createStorageInstance(p)];case 1:return S=W.sent(),k=S.bulkWrite.bind(S),S.bulkWrite=function(n,r){return e(this,void 0,void 0,(function(){var e;return t(this,(function(t){switch(t.label){case 0:return[4,k(n,r)];case 1:return(e=t.sent()).success[o]&&e.success[o].data.instanceToken===w&&(I.firstInstanceTokens[w]=new Set),[2,e]}}))}))},[2,S];case 2:return p.schema.title!==m.title?[3,4]:[4,this.settings.storage.createStorageInstance(p)];case 3:return[2,S=W.sent()];case 4:return x=c(p),this.settings.keepIndexesOnParent||(x.schema=c(x.schema),x.schema.indexes=[]),T=this.settings.storage.createStorageInstance(x),N=v.createStorageInstance(Object.assign({},Object.assign({},p,{multiInstance:!1,databaseInstanceToken:s(10)}),{collectionName:p.collectionName+"-memory-synced-"+s(12)})),P=v.createStorageInstance({databaseName:p.databaseName,collectionName:p.collectionName+"-meta-instance"+s(12),schema:i,multiInstance:!1,databaseInstanceToken:s(10),options:{}}),z=new g,_=new g,j=Promise.all([N,P,T]).then((function(a){var i=n(a,3),o=i[0],c=i[1],l=i[2],f=function(n,r){return e(H,void 0,void 0,(function(){var e,a;return t(this,(function(t){switch(t.label){case 0:return e={id:s(10),context:r,input:n},a=b(_.pipe(y((function(t){return t.id===e.id})))),z.next(e),[4,a];case 1:return[2,t.sent().output]}}))}))};return r({identifier:"memory-synced-storage-"+s(10),pullBatchSize:H.settings.batchSize?H.settings.batchSize:50,pushBatchSize:H.settings.batchSize?H.settings.batchSize:50,replicationHandler:u(l,f,h),conflictHandler:f,forkInstance:o,metaInstance:c,waitBeforePersist:H.settings.waitBeforePersist,hashFunction:h})})),this.firstInstanceTokens[w]&&!this.firstInstanceTokens[w].has(p.collectionName)?(this.firstInstanceTokens[w].add(p.collectionName),B=N):B=j.then((function(e){return a(e)})),O=d.bind,Q=[void 0,this,p.databaseName,p.collectionName,p.schema],E={masterInstancePromise:T,metaInstancePromise:P},[4,N];case 5:return[2,new(O.apply(d,Q.concat([(E.forkInstance=W.sent(),E.initDonePromise=B,E.replicationStatePromise=j,E.conflictTasks$=z,E.resolvedConflictTasks$=_,E),{}])))]}}))}))},p}();export{w as RxStorageMemorySynced};export function getMemorySyncedRxStorage(e){return new w(e)}export*from"./memory-synced-types";export*from"./memory-synced-storage-instance";