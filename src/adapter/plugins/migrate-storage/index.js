var e=this&&this.__awaiter||function(e,t,n,r){function a(e){return e instanceof n?e:new n((function(t){t(e)}))}return new(n||(n=Promise))((function(n,o){function i(e){try{s(r.next(e))}catch(e){o(e)}}function c(e){try{s(r.throw(e))}catch(e){o(e)}}function s(e){e.done?n(e.value):a(e.value).then(i,c)}s((r=r.apply(e,t||[])).next())}))},t=this&&this.__generator||function(e,t){var n,r,a,o,i={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]};return o={next:c(0),throw:c(1),return:c(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function c(e){return function(t){return s([e,t])}}function s(c){if(n)throw new TypeError("Generator is already executing.");for(;o&&(o=0,c[0]&&(i=0)),i;)try{if(n=1,r&&(a=2&c[0]?r.return:c[0]?r.throw||((a=r.return)&&a.call(r),0):r.next)&&!(a=a.call(r,c[1])).done)return a;switch(r=0,a&&(c=[2&c[0],a.value]),c[0]){case 0:case 1:a=c;break;case 4:return i.label++,{value:c[1],done:!1};case 5:i.label++,r=c[1],c=[0];continue;case 7:c=i.ops.pop(),i.trys.pop();continue;default:if(!(a=i.trys,(a=a.length>0&&a[a.length-1])||6!==c[0]&&2!==c[0])){i=0;continue}if(3===c[0]&&(!a||c[1]>a[0]&&c[1]<a[3])){i.label=c[1];break}if(6===c[0]&&i.label<a[1]){i.label=a[1],a=c;break}if(a&&i.label<a[2]){i.label=a[2],i.ops.push(c);break}a[2]&&i.ops.pop(),i.trys.pop();continue}c=t.call(e,i)}catch(e){c=[6,e],r=0}finally{n=a=0}if(5&c[0])throw c[1];return{value:c[0]?c[1]:void 0,done:!0}}},n=this&&this.__values||function(e){var t="function"==typeof Symbol&&Symbol.iterator,n=t&&e[t],r=0;if(n)return n.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&r>=e.length&&(e=void 0),{value:e&&e[r++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")},r=this&&this.__read||function(e,t){var n="function"==typeof Symbol&&e[Symbol.iterator];if(!n)return e;var r,a,o=n.call(e),i=[];try{for(;(void 0===t||t-- >0)&&!(r=o.next()).done;)i.push(r.value)}catch(e){a={error:e}}finally{try{r&&!r.done&&(n=o.return)&&n.call(o)}finally{if(a)throw a.error}}return i};import{blobBufferUtil as a,createRevision as o,clone as i,randomCouchString as c,now as s}from"rxdb";export function migrateStorage(r,a,o,i,c){return void 0===i&&(i=10),e(this,void 0,void 0,(function(){var e,s,l,u,f,m;return t(this,(function(t){switch(t.label){case 0:e=Object.values(r.collections),t.label=1;case 1:t.trys.push([1,6,7,8]),s=n(e),l=s.next(),t.label=2;case 2:return l.done?[3,5]:[4,migrateCollection(l.value,a,o,i,c)];case 3:t.sent(),t.label=4;case 4:return l=s.next(),[3,2];case 5:return[3,8];case 6:return u=t.sent(),f={error:u},[3,8];case 7:try{l&&!l.done&&(m=s.return)&&m.call(s)}finally{if(f)throw f.error}return[7];case 8:return[2]}}))}))}export function migrateCollection(n,l,u,f,m){return e(this,void 0,void 0,(function(){var h,d,b,v,p,y,g,w=this;return t(this,(function(_){switch(_.label){case 0:return console.log("start migrateCollection() for "+n.name),h=n.schema.jsonSchema,d=n.schema.primaryPath,[4,u.createStorageInstance({databaseName:l,collectionName:n.name,multiInstance:!1,options:{},schema:h,databaseInstanceToken:c(10)})];case 1:b=_.sent(),v=u.statics.prepareQuery(h,{selector:{},limit:f,sort:[(g={},g[d]="asc",g)],skip:0}),p=function(){var c,u,f,p,y,g,_;return t(this,(function(x){switch(x.label){case 0:return console.log("migrateCollection("+n.name+") loop once"),[4,b.query(v)];case 1:return c=x.sent(),0!==(u=c.documents).length?[3,3]:(console.log("migrateCollection("+n.name+") migration of collection done"),[4,b.remove()]);case 2:return x.sent(),[2,{value:void 0}];case 3:return f=i(u),h.attachments?[4,Promise.all(u.map((function(n){return e(w,void 0,void 0,(function(){var o,i=this;return t(this,(function(c){switch(c.label){case 0:return o=n[d],[4,Promise.all(Object.entries(n._attachments).map((function(c){var s=r(c,2),l=s[0],u=s[1];return e(i,void 0,void 0,(function(){var e,r;return t(this,(function(t){switch(t.label){case 0:return[4,b.getAttachmentData(o,l)];case 1:return e=t.sent(),[4,a.toBase64String(e)];case 2:return r=t.sent(),n._attachments[l]={data:r,digest:u.digest,length:u.length,type:u.type},[2]}}))}))})))];case 1:return c.sent(),[2]}}))}))})))]:[3,5];case 4:x.sent(),x.label=5;case 5:return p=u.map((function(e){return e._meta||(e._meta={lwt:s()}),{document:e}})),[4,n.storageInstance.bulkWrite(p,"migrate-v11-to-old")];case 6:y=x.sent(),g=u.map((function(e,t){var r=f[t];r._meta||(r._meta={lwt:(new Date).getTime()});var a=i(r);return a._deleted=!0,a._meta||(a._meta={lwt:(new Date).getTime()}),a._meta.lwt=(new Date).getTime()+1,a._rev=o(n.database.hashFunction,a,r),{previous:r,document:a}})),x.label=7;case 7:return x.trys.push([7,9,,10]),[4,b.bulkWrite(g,"migrate-between-rxdb-versions")];case 8:return x.sent(),[3,10];case 9:throw _=x.sent(),console.log("migrateCollection("+n.name+")- could not delete on old instance"),console.dir(_),_;case 10:return[4,b.cleanup(0)];case 11:return x.sent(),m?[4,m({databaseName:n.database.name,collectionName:n.name,oldDatabaseName:l,insertToNewWriteRows:p,writeToNewResult:y})]:[3,13];case 12:x.sent(),x.label=13;case 13:return[2]}}))},_.label=2;case 2:return[5,p()];case 3:return"object"==typeof(y=_.sent())?[2,y.value]:[3,2];case 4:return[2]}}))}))}