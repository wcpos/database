var e=this&&this.__awaiter||function(e,r,t,n){function a(e){return e instanceof t?e:new t((function(r){r(e)}))}return new(t||(t=Promise))((function(t,o){function i(e){try{u(n.next(e))}catch(e){o(e)}}function s(e){try{u(n.throw(e))}catch(e){o(e)}}function u(e){e.done?t(e.value):a(e.value).then(i,s)}u((n=n.apply(e,r||[])).next())}))},r=this&&this.__generator||function(e,r){var t,n,a,o,i={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]};return o={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function s(e){return function(r){return u([e,r])}}function u(s){if(t)throw new TypeError("Generator is already executing.");for(;o&&(o=0,s[0]&&(i=0)),i;)try{if(t=1,n&&(a=2&s[0]?n.return:s[0]?n.throw||((a=n.return)&&a.call(n),0):n.next)&&!(a=a.call(n,s[1])).done)return a;switch(n=0,a&&(s=[2&s[0],a.value]),s[0]){case 0:case 1:a=s;break;case 4:return i.label++,{value:s[1],done:!1};case 5:i.label++,n=s[1],s=[0];continue;case 7:s=i.ops.pop(),i.trys.pop();continue;default:if(!(a=i.trys,(a=a.length>0&&a[a.length-1])||6!==s[0]&&2!==s[0])){i=0;continue}if(3===s[0]&&(!a||s[1]>a[0]&&s[1]<a[3])){i.label=s[1];break}if(6===s[0]&&i.label<a[1]){i.label=a[1],a=s;break}if(a&&i.label<a[2]){i.label=a[2],i.ops.push(s);break}a[2]&&i.ops.pop(),i.trys.pop();continue}s=r.call(e,i)}catch(e){s=[6,e],n=0}finally{t=a=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}},t=this&&this.__read||function(e,r){var t="function"==typeof Symbol&&e[Symbol.iterator];if(!t)return e;var n,a,o=t.call(e),i=[];try{for(;(void 0===r||r-- >0)&&!(n=o.next()).done;)i.push(n.value)}catch(e){a={error:e}}finally{try{n&&!n.done&&(t=o.return)&&t.call(o)}finally{if(a)throw a.error}}return i},n=this&&this.__values||function(e){var r="function"==typeof Symbol&&Symbol.iterator,t=r&&e[r],n=0;if(t)return t.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&n>=e.length&&(e=void 0),{value:e&&e[n++],done:!e}}};throw new TypeError(r?"Object is not iterable.":"Symbol.iterator is not defined.")};import{clone as a,createRevision as o,defaultHashFunction as i,fillWithDefaultSettings as s,getFromMapOrThrow as u,getPrimaryFieldOfPrimaryKey as c,normalizeMangoQuery as l,randomCouchString as f,requestIdlePromise as h,shuffleArray as p}from"rxdb";import{averageOfTimeValues as d,getFieldsOfQuery as y,sortIndexTimes as m}from"./query-optimizer-helper";import*as b from"percom";export function findBestIndex(v){return e(this,void 0,void 0,(function(){var e,x,w,_,g,I,S,q,O,j,E,k,A,M,B,P,T,z,C,F,N,D,G,K,Q,W,H,J,L,R,U,V,X,Y,Z,$;return r(this,(function(r){switch(r.label){case 0:return e=c(v.schema.primaryKey),x=v.maxFieldsPerIndex?v.maxFieldsPerIndex:4,w=a(s(v.schema)),(_=new Map).set(e,[e]),g=new Map,I={},S={},Object.entries(v.queries).forEach((function(r){var n=t(r,2),a=n[0],o=n[1];I[a]=o,S[a]=new Map;var i=Array.from(y(w,o)).filter((function(r){return r!==e})),s=new Map;s.set(e,[e]),g.set(a,s),new Array(x).fill(0).forEach((function(e,r){var t=r+1;i.length>=t&&b.per(i,t).forEach((function(e){var r=e.join(",");_.set(r,e),s.set(r,e)}))}))})),w.indexes=Array.from(_.values()).filter((function(r){return 1!==r.length||r[0]!==e})),w=s(w),[4,v.storage.createStorageInstance({schema:w,databaseName:"findBestIndex_"+f(6),collectionName:"findBestIndex_"+f(6),databaseInstanceToken:f(10),multiInstance:!1,options:v.instanceCreationOptions?v.instanceCreationOptions:{}})];case 1:return[4,(q=r.sent()).bulkWrite(v.testData.map((function(e){var r=Object.assign({_rev:"",_deleted:!1,_meta:{lwt:1},_attachments:{}},e);return r._rev=o(i,r),{document:r}})),"query-optimizer")];case 2:r.sent(),O=0,r.label=3;case 3:if(!(O<v.runs))return[3,22];r.label=4;case 4:r.trys.push([4,19,20,21]),X=void 0,j=n(Object.entries(I)),E=j.next(),r.label=5;case 5:if(E.done)return[3,18];k=t(E.value,2),A=k[0],M=k[1],B=u(g,A),P=Array.from(B.entries()),P=p(P),r.label=6;case 6:r.trys.push([6,15,16,17]),Z=void 0,T=n(P),z=T.next(),r.label=7;case 7:return z.done?[3,14]:(C=t(z.value,2),F=C[0],N=C[1],[4,h()]);case 8:case 9:return r.sent(),[4,h()];case 10:return r.sent(),(D=a(M)).index=N,D=l(w,D),G=v.storage.statics.prepareQuery(w,D),[4,h()];case 11:return r.sent(),K=performance.now(),[4,q.query(G)];case 12:r.sent(),Q=performance.now(),W=Q-K,H=S[A],(J=H.has(F)?u(H,F):[]).push(W),H.set(F,J),r.label=13;case 13:return z=T.next(),[3,7];case 14:return[3,17];case 15:return L=r.sent(),Z={error:L},[3,17];case 16:try{z&&!z.done&&($=T.return)&&$.call(T)}finally{if(Z)throw Z.error}return[7];case 17:return E=j.next(),[3,5];case 18:return[3,21];case 19:return R=r.sent(),X={error:R},[3,21];case 20:try{E&&!E.done&&(Y=j.return)&&Y.call(j)}finally{if(X)throw X.error}return[7];case 21:return O++,[3,3];case 22:return U=new Map,Object.entries(S).forEach((function(e){var r=t(e,2),n=r[0],a=r[1],o=Array.from(a.entries()).map((function(e){var r=t(e,2),n=r[0],a=r[1],o=u(_,n);return a=a.sort((function(e,r){return e-r})),{index:o,time:d(a,66)}}));o=m(o),U.set(n,o)})),[4,q.remove()];case 23:return r.sent(),V={queries:{},indexesInSchema:w.indexes},Object.entries(v.queries).forEach((function(e){var r=t(e,2),n=r[0],a=r[1],o=u(U,n),i=o[0];V.queries[n]={query:a,bestIndex:i,allIndexes:o}})),[2,V]}}))}))}