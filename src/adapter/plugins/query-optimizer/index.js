import{clone as e,createRevision as r,fillWithDefaultSettings as a,getFromMapOrThrow as t,getPrimaryFieldOfPrimaryKey as n,normalizeMangoQuery as s,randomCouchString as i,requestIdlePromise as o,shuffleArray as m}from"rxdb";import{averageOfTimeValues as c,getFieldsOfQuery as f,sortIndexTimes as d}from"./query-optimizer-helper";import*as p from"percom";export async function findBestIndex(v){var u=n(v.schema.primaryKey),l=v.maxFieldsPerIndex?v.maxFieldsPerIndex:4,w=e(a(v.schema)),x=new Map;x.set(u,[u]);var h=new Map,y={},I={};Object.entries(v.queries).forEach((([e,r])=>{y[e]=r,I[e]=new Map;var a=Array.from(f(w,r)).filter((e=>e!==u)),t=new Map;t.set(u,[u]),h.set(e,t),new Array(l).fill(0).forEach(((e,r)=>{var n=r+1;a.length>=n&&p.per(a,n).forEach((e=>{var r=e.join(",");x.set(r,e),t.set(r,e)}))}))})),w.indexes=Array.from(x.values()).filter((e=>1!==e.length||e[0]!==u)),w=a(w);var b=i(10),q=await v.storage.createStorageInstance({schema:w,databaseName:"findBestIndex_"+i(6),collectionName:"findBestIndex_"+i(6),multiInstance:!1,databaseInstanceToken:b,options:v.instanceCreationOptions?v.instanceCreationOptions:{},devMode:!1});await q.bulkWrite(v.testData.map((e=>{var a=Object.assign({_rev:"",_deleted:!1,_meta:{lwt:1},_attachments:{}},e);return a._rev=r(b,a),{document:a}})),"query-optimizer");for(var O=0;O<v.runs;){for(var[_,g]of Object.entries(y)){var j=t(h,_),M=Array.from(j.entries());for(var[A,E]of M=m(M)){await o(),await o(),await o();var B=e(g);B.index=E,B=s(w,B);var k=v.storage.statics.prepareQuery(w,B);await o();var z=performance.now();await q.query(k);var C=performance.now()-z,F=I[_],N=F.has(A)?t(F,A):[];N.push(C),F.set(A,N)}}O++}var P=new Map;Object.entries(I).forEach((([e,r])=>{var a=Array.from(r.entries()).map((([e,r])=>{var a=t(x,e);return r=r.sort(((e,r)=>e-r)),{index:a,time:c(r,66)}}));a=d(a),P.set(e,a)})),await q.remove();var S={queries:{},indexesInSchema:w.indexes};return Object.entries(v.queries).forEach((([e,r])=>{var a=t(P,e),n=a[0];S.queries[e]={query:r,bestIndex:n,allIndexes:a}})),S}