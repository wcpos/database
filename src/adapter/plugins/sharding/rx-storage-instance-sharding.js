var t=this&&this.__awaiter||function(t,n,e,r){function i(t){return t instanceof e?t:new e((function(n){n(t)}))}return new(e||(e=Promise))((function(e,s){function o(t){try{c(r.next(t))}catch(t){s(t)}}function a(t){try{c(r.throw(t))}catch(t){s(t)}}function c(t){t.done?e(t.value):i(t.value).then(o,a)}c((r=r.apply(t,n||[])).next())}))},n=this&&this.__generator||function(t,n){var e,r,i,s,o={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return s={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function a(t){return function(n){return c([t,n])}}function c(s){if(e)throw new TypeError("Generator is already executing.");for(;o;)try{if(e=1,r&&(i=2&s[0]?r.return:s[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,s[1])).done)return i;switch(r=0,i&&(s=[2&s[0],i.value]),s[0]){case 0:case 1:i=s;break;case 4:return o.label++,{value:s[1],done:!1};case 5:o.label++,r=s[1],s=[0];continue;case 7:s=o.ops.pop(),o.trys.pop();continue;default:if(!(i=o.trys,(i=i.length>0&&i[i.length-1])||6!==s[0]&&2!==s[0])){o=0;continue}if(3===s[0]&&(!i||s[1]>i[0]&&s[1]<i[3])){o.label=s[1];break}if(6===s[0]&&o.label<i[1]){o.label=i[1],i=s;break}if(i&&o.label<i[2]){o.label=i[2],o.ops.push(s);break}i[2]&&o.ops.pop(),o.trys.pop();continue}s=n.call(t,o)}catch(t){s=[6,t],r=0}finally{e=i=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}},e=this&&this.__read||function(t,n){var e="function"==typeof Symbol&&t[Symbol.iterator];if(!e)return t;var r,i,s=e.call(t),o=[];try{for(;(void 0===n||n-- >0)&&!(r=s.next()).done;)o.push(r.value)}catch(t){i={error:t}}finally{try{r&&!r.done&&(e=s.return)&&e.call(s)}finally{if(i)throw i.error}}return o},r=this&&this.__spreadArray||function(t,n,e){if(e||2===arguments.length)for(var r,i=0,s=n.length;i<s;i++)!r&&i in n||(r||(r=Array.prototype.slice.call(n,0,i)),r[i]=n[i]);return t.concat(r||Array.prototype.slice.call(n))};import{flatClone as i,getPrimaryFieldOfPrimaryKey as s}from"rxdb";import{merge as o,Subject as a}from"rxjs";import{getShardIndex as c}from"./sharding-helper";var u=function(){function u(t,n,e,r,o,c){var u=this;this.storage=t,this.databaseName=n,this.collectionName=e,this.schema=r,this.internals=o,this.options=c,this.changes$=new a,this.primaryPath=s(this.schema.primaryKey),this.internals.shardInstances.forEach((function(t,n){t.changeStream().subscribe((function(t){var e,r=i(t);r.checkpoint=((e={})[n]=t.checkpoint,e),u.changes$.next(r)}))}))}return u.prototype.bulkWrite=function(r,i){return t(this,void 0,void 0,(function(){var t,s,o,a=this;return n(this,(function(n){switch(n.label){case 0:return t=this.internals.shardInstances,s=new Map,r.forEach((function(n){var e=n.document[a.primaryPath],r=c(t,e),i=s.get(r);i||(i=[],s.set(r,i)),i.push(n)})),o={success:{},error:{}},[4,Promise.all(Array.from(s.entries()).map((function(t){var n=e(t,2),r=n[0],s=n[1];if(s.length>0)return a.internals.shardInstances[r].bulkWrite(s,i).then((function(t){Object.entries(t.error).forEach((function(t){var n=e(t,2),r=n[0],i=n[1];o.error[r]=i})),Object.entries(t.success).forEach((function(t){var n=e(t,2),r=n[0],i=n[1];o.success[r]=i}))}))})))];case 1:return n.sent(),[2,o]}}))}))},u.prototype.findDocumentsById=function(r,i){return t(this,void 0,void 0,(function(){var t,s,o,a=this;return n(this,(function(n){switch(n.label){case 0:return t=this.internals.shardInstances,s=new Map,r.forEach((function(n){var e=c(t,n),r=s.get(e);r||(r=[],s.set(e,r)),r.push(n)})),o={},[4,Promise.all(Array.from(s.entries()).map((function(t){var n=e(t,2),r=n[0],s=n[1];if(s.length>0)return a.internals.shardInstances[r].findDocumentsById(s,i).then((function(t){Object.entries(t).forEach((function(t){var n=e(t,2),r=n[0],i=n[1];o[r]=i}))}))})))];case 1:return n.sent(),[2,o]}}))}))},u.prototype.query=function(e){return t(this,void 0,void 0,(function(){var r,i,s,o,a=this;return n(this,(function(c){switch(c.label){case 0:return 0,(r=e.originalQuery).limit&&r.limit,i=r.skip?r.skip:0,i,s=[],[4,Promise.all(this.internals.shardInstances.map((function(r,i){return t(a,void 0,void 0,(function(){var t;return n(this,(function(n){switch(n.label){case 0:return[4,r.query(e.parentPreparedQuery)];case 1:return t=n.sent(),s=s.concat(t.documents),[2]}}))}))})))];case 1:return c.sent(),o=this.storage.statics.getSortComparator(this.schema,e),s=(s=s.sort(o)).slice(i),r.limit&&(s=s.slice(0,r.limit)),[2,{documents:s}]}}))}))},u.prototype.getChangedDocumentsSince=function(e,r){return t(this,void 0,void 0,(function(){var s,o,a,c,u,h,l,f,p,d,m,v=this;return n(this,(function(y){switch(y.label){case 0:return s=this.internals.shardInstances,o=r?i(r):{},[4,Promise.all(s.map((function(r,i){return t(v,void 0,void 0,(function(){var t;return n(this,(function(n){switch(n.label){case 0:return t=o[i],[4,r.getChangedDocumentsSince(e,t)];case 1:return[2,n.sent()]}}))}))})))];case 1:a=y.sent(),c=[],u=0,h=0,y.label=2;case 2:return h<a.length?u===e?[3,6]:(l=a[h],f=l.documents.length,u+f<=e?(u+=f,c.push({checkpoint:l.checkpoint,documents:l.documents,shardIndex:h}),[3,5]):[3,3]):[3,6];case 3:return p=e-u,[4,s[h].getChangedDocumentsSince(p,o[h])];case 4:d=y.sent(),u+=d.documents.length,c.push({checkpoint:d.checkpoint,documents:d.documents,shardIndex:h}),y.label=5;case 5:return h++,[3,2];case 6:return m=[],c.forEach((function(t){m=m.concat(t.documents),o[t.shardIndex]=t.checkpoint})),[2,{documents:m,checkpoint:o}]}}))}))},u.prototype.getAttachmentData=function(t,n){var e=c(this.internals.shardInstances,t);return this.internals.shardInstances[e].getAttachmentData(t,n)},u.prototype.changeStream=function(){return this.changes$.asObservable()},u.prototype.cleanup=function(e){return t(this,void 0,void 0,(function(){var t;return n(this,(function(n){switch(n.label){case 0:return[4,Promise.all(this.internals.shardInstances.map((function(t){return t.cleanup(e)})))];case 1:return t=n.sent(),t.find((function(t){return!1===t}))?[2,!1]:[2,!0]}}))}))},u.prototype.close=function(){return this.changes$.complete(),Promise.all(this.internals.shardInstances.map((function(t){return t.close()}))).then((function(){}))},u.prototype.remove=function(){return this.changes$.complete(),Promise.all(this.internals.shardInstances.map((function(t){return t.remove()}))).then((function(){}))},u.prototype.conflictResultionTasks=function(){var t=this.internals.shardInstances.map((function(t){return t.conflictResultionTasks()}));return o.apply(void 0,r([],e(t),!1))},u.prototype.resolveConflictResultionTask=function(t){return Promise.all(this.internals.shardInstances.map((function(n){return n.resolveConflictResultionTask(t)}))).then((function(){}))},u}();export{u as RxStorageInstanceSharding};