var r=this&&this.__read||function(r,e){var t="function"==typeof Symbol&&r[Symbol.iterator];if(!t)return r;var a,o,n=t.call(r),u=[];try{for(;(void 0===e||e-- >0)&&!(a=n.next()).done;)u.push(a.value)}catch(r){o={error:r}}finally{try{a&&!a.done&&(t=n.return)&&t.call(n)}finally{if(o)throw o.error}}return u};import{clone as e,DEFAULT_CHECKPOINT_SCHEMA as t,randomCouchString as a}from"rxdb";import{getDexieSortComparator as o,RxStorageDexieStatics as n}from"rxdb/plugins/dexie";import{getIndexId as u,isPlainObject as s}from"./sqlite-helpers";export var RxStorageSQLiteStatics={prepareQuery:function(r,t){var a=t.limit?"LIMIT "+t.limit:"LIMIT -1",o=t.skip?"OFFSET "+t.skip:"",n=[],s="",i=void 0,c="";t.index&&(c='INDEXED BY "'+u(t.index)+'"');var p=mangoQuerySortToSQL(t.sort);try{var l=mangoQuerySelectorToSQL(r,t.selector,n);s=c+" WHERE deleted=0 "+(l="()"!==l?" AND "+l+" ":"")+p+" "+a+" "+o+" ;"}catch(r){if(!r.isNonImplementedOperatorError)throw r;i=r.operator,s=c+" WHERE deleted=0 "+p+" LIMIT 50 "}return{schema:r,mangoQuery:e(t),sqlQuery:{query:s,params:n},queryWithoutSort:s.replace(p," "),nonImplementedOperator:i}},getSortComparator:function(r,e){return o(r,e.mangoQuery)},getQueryMatcher:function(r,e){return n.getQueryMatcher(r,{query:e.mangoQuery})},checkpointSchema:t};var i=["$or","$and"];export function mangoQuerySelectorToSQL(e,t,o,n){return"("+Object.entries(t).map((function(t){var u=r(t,2),c=u[0],p=u[1];if(!c.startsWith("$")){if(s(p))return mangoQuerySelectorToSQL(e,p,o,c);d="?";return o.push(p),"json_extract(data, '$."+c+"')="+d}if(i.includes(c)){var l=c.substring(1).toUpperCase();return p.map((function(r){return mangoQuerySelectorToSQL(e,r,o,n)})).join(" "+l+" ")}if(!n)throw new Error("cannot have selector operator on the top level "+c);var d="?";switch(c){case"$eq":return o.push(p),"json_extract(data, '$."+n+"')="+d;case"$ne":return o.push(p),"json_extract(data, '$."+n+"')!="+d;case"$gt":return o.push(p),"json_extract(data, '$."+n+"')>"+d;case"$gte":return o.push(p),"json_extract(data, '$."+n+"')>="+d;case"$lt":return o.push(p),"json_extract(data, '$."+n+"')<"+d;case"$lte":return o.push(p),"json_extract(data, '$."+n+"')<="+d;case"$exists":return p?(o.push("rand-"+a(10)),"json_extract(data, '$."+n+"')!="+d):"json_extract(data, '$."+n+"') IS NULL";case"$in":return o.push(p),"json_extract(data, '$."+n+"') IN ("+d+")";case"$nin":return o.push(p),"json_extract(data, '$."+n+"') NOT IN ("+d+")";default:var m=new Error("operator "+c+" not implemented");throw m.operator=c,m.isNonImplementedOperatorError=!0,m}})).join(" AND ")+")"}export function mangoQuerySortToSQL(e){return"ORDER BY "+e.map((function(e){var t=r(Object.entries(e)[0],2);return"json_extract(data, '$."+t[0]+"') "+t[1].toUpperCase()})).join(", ")}