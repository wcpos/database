var t=this&&this.__awaiter||function(t,e,n,a){function s(t){return t instanceof n?t:new n((function(e){e(t)}))}return new(n||(n=Promise))((function(n,i){function r(t){try{o(a.next(t))}catch(t){i(t)}}function c(t){try{o(a.throw(t))}catch(t){i(t)}}function o(t){t.done?n(t.value):s(t.value).then(r,c)}o((a=a.apply(t,e||[])).next())}))},e=this&&this.__generator||function(t,e){var n,a,s,i,r={label:0,sent:function(){if(1&s[0])throw s[1];return s[1]},trys:[],ops:[]};return i={next:c(0),throw:c(1),return:c(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function c(t){return function(e){return o([t,e])}}function o(c){if(n)throw new TypeError("Generator is already executing.");for(;i&&(i=0,c[0]&&(r=0)),r;)try{if(n=1,a&&(s=2&c[0]?a.return:c[0]?a.throw||((s=a.return)&&s.call(a),0):a.next)&&!(s=s.call(a,c[1])).done)return s;switch(a=0,s&&(c=[2&c[0],s.value]),c[0]){case 0:case 1:s=c;break;case 4:return r.label++,{value:c[1],done:!1};case 5:r.label++,a=c[1],c=[0];continue;case 7:c=r.ops.pop(),r.trys.pop();continue;default:if(!(s=r.trys,(s=s.length>0&&s[s.length-1])||6!==c[0]&&2!==c[0])){r=0;continue}if(3===c[0]&&(!s||c[1]>s[0]&&c[1]<s[3])){r.label=c[1];break}if(6===c[0]&&r.label<s[1]){r.label=s[1],s=c;break}if(s&&r.label<s[2]){r.label=s[2],r.ops.push(c);break}s[2]&&r.ops.pop(),r.trys.pop();continue}c=e.call(t,r)}catch(t){c=[6,t],a=0}finally{n=s=0}if(5&c[0])throw c[1];return{value:c[0]?c[1]:void 0,done:!0}}};import{getPrimaryFieldOfPrimaryKey as n,categorizeBulkWriteRows as a,isMaybeReadonlyArray as s,ensureNotFalsy as i,sortDocumentsByLastWriteTime as r,addRxStorageMultiInstanceSupport as c,PROMISE_RESOLVE_VOID as o,getNewestOfDocumentStates as u,lastOfArray as l,getFromMapOrThrow as h}from"rxdb";import{Subject as m}from"rxjs";import{RxStorageSQLiteStatics as d}from"./sqlite-statics";import{attachmentRowKey as p,closeDatabaseConnection as f,getDatabaseConnection as E,getIndexId as y,getSQLiteFindByIdSQL as N,getSQLiteUpdateSQL as v,RX_STORAGE_NAME_SQLITE as T,sqliteTransaction as b}from"./sqlite-helpers";var I=0,q=function(){function s(t,e,a,s,i,r,c){this.storage=t,this.databaseName=e,this.collectionName=a,this.schema=s,this.internals=i,this.options=r,this.settings=c,this.changes$=new m,this.instanceId=I++,this.closed=!1,this.sqliteBasics=this.storage.settings.sqliteBasics,this.primaryPath=n(this.schema.primaryKey)}return s.prototype.bulkWrite=function(n,s){return t(this,void 0,void 0,(function(){var r,c,o,l,m,d,f=this;return e(this,(function(E){switch(E.label){case 0:return r=this.internals.database,c={success:{},error:{}},o=n.map((function(t){return t.document[f.primaryPath]})),l=[],[4,b(r,this.sqliteBasics,(function(){return t(f,void 0,void 0,(function(){var t,i,u,d,f,E=this;return e(this,(function(e){switch(e.label){case 0:return[4,this.sqliteBasics.all(r,{query:'SELECT data FROM "'+this.collectionName+'" WHERE id IN ('+o.map((function(){return"?"})).join(", ")+")",params:o})];case 1:return t=e.sent(),i=new Map,t.forEach((function(t){var e=JSON.parse(t.data),n=e[E.primaryPath];i.set(n,e)})),m=a(this,this.primaryPath,i,n,s),u=new Map,m.bulkInsertDocs.length>0&&(d='INSERT INTO "'.concat(this.collectionName,'"(\n                        id,\n                        revision,\n                        deleted,\n                        lastWriteTime,\n                        data\n                    ) VALUES ').concat(new Array(m.bulkInsertDocs.length).fill("(?, ?, ?, ?, ?)").join(", "),";"),f=[],m.bulkInsertDocs.forEach((function(t){var e=t.document,n=e[E.primaryPath];u.set(n,e),f.push(n),f.push(e._rev),f.push(e._deleted?1:0),f.push(e._meta.lwt),f.push(JSON.stringify(e)),c.success[e[E.primaryPath]]=e})),l.push(this.sqliteBasics.run(r,{query:d,params:f}))),m.bulkUpdateDocs.length>0&&m.bulkUpdateDocs.forEach((function(t){var e=t.document[E.primaryPath];u.set(e,t.document),c.success[e]=t.document,l.push(E.sqliteBasics.run(r,v(E.collectionName,E.primaryPath,t)))})),m.attachmentsAdd.forEach((function(t){var e=E.sqliteBasics.all(E.internals.database,{query:'\n                                INSERT INTO\n                                    "'.concat(E.collectionName,'_attachments"(\n                                        docIdWithAttachmentId,\n                                        digest,\n                                        length,\n                                        type,\n                                        data\n                                    )\n                                VALUES(?, ?, ?, ?, ?)\n                            '),params:[p(t.documentId,t.attachmentId),h(u,t.documentId)._attachments[t.attachmentId].digest,t.attachmentData.length,t.attachmentData.type,t.attachmentData.data]});l.push(e)})),m.attachmentsRemove.forEach((function(t){var e=E.sqliteBasics.all(E.internals.database,{query:'\n                            DELETE FROM\n                                "'.concat(E.collectionName,'_attachments"\n                            WHERE\n                                docIdWithAttachmentId = ?\n                            '),params:[p(t.documentId,t.attachmentId)]});l.push(e)})),m.attachmentsUpdate.forEach((function(t){var e=E.sqliteBasics.all(E.internals.database,{query:'\n                            UPDATE "'.concat(E.collectionName,'_attachments"\n                            SET\n                                digest = ?,\n                                length = ?,\n                                type = ?,\n                                data = ?\n                            WHERE\n                                docIdWithAttachmentId = ?\n                            '),params:[h(u,t.documentId)._attachments[t.attachmentId].digest,t.attachmentData.length,t.attachmentData.type,t.attachmentData.data,p(t.documentId,t.attachmentId)]});l.push(e)})),c.error=m.errors,[4,Promise.all(l)];case 2:return e.sent(),this.closed?[2,"ROLLBACK"]:[2,"COMMIT"]}}))}))}),{databaseName:this.databaseName,collectionName:this.collectionName})];case 1:return E.sent(),i(m).eventBulk.events.length>0&&(d=u(this.primaryPath,Object.values(c.success)),i(m).eventBulk.checkpoint={id:d[this.primaryPath],lwt:d._meta.lwt},this.changes$.next(i(m).eventBulk)),[2,c]}}))}))},s.prototype.query=function(n){return t(this,void 0,void 0,(function(){var t,a,s,i,r,c,o,u,l;return e(this,(function(e){switch(e.label){case 0:if(!n.nonImplementedOperator)return[3,4];t=n.mangoQuery,a=t.skip?t.skip:0,s=t.limit?t.limit:1/0,i=a+s,r=[],c=d.getQueryMatcher(this.schema,n),o=0,u=!1,e.label=1;case 1:return!1!==u?[3,3]:[4,this.sqliteBasics.all(this.internals.database,{query:'SELECT data FROM "'+this.collectionName+'" '+n.sqlQuery.query+" OFFSET "+o,params:n.sqlQuery.params})];case 2:return l=e.sent(),o+=l.length,l.forEach((function(t){var e=JSON.parse(t.data);c(e)&&r.push(e)})),(0===l.length||r.length>=i)&&(u=!0),[3,1];case 3:return[2,{documents:r=r.slice(a,i)}];case 4:return[4,this.sqliteBasics.all(this.internals.database,{query:'SELECT data FROM "'+this.collectionName+'" '+n.sqlQuery.query,params:n.sqlQuery.params})];case 5:return[2,{documents:e.sent().map((function(t){return JSON.parse(t.data)}))}]}}))}))},s.prototype.count=function(n){return t(this,void 0,void 0,(function(){var t;return e(this,(function(e){switch(e.label){case 0:return[4,this.sqliteBasics.all(this.internals.database,{query:'SELECT COUNT(1) as count FROM "'+this.collectionName+'" '+n.queryWithoutSort,params:n.sqlQuery.params})];case 1:return t=e.sent(),[2,{count:t[0].count,mode:"fast"}]}}))}))},s.prototype.findDocumentsById=function(n,a){return t(this,void 0,void 0,(function(){var t,s;return e(this,(function(e){switch(e.label){case 0:return[4,this.sqliteBasics.all(this.internals.database,N(this.collectionName,n,a))];case 1:return t=e.sent(),s={},t.forEach((function(t){s[t.id]=JSON.parse(t.data)})),[2,s]}}))}))},s.prototype.getChangedDocumentsSince=function(n,a){return t(this,void 0,void 0,(function(){var s,i,c,o=this;return e(this,(function(u){switch(u.label){case 0:return s=a?[{wherePart:"WHERE lastWriteTime > (?)",params:[a.lwt]},{wherePart:"WHERE lastWriteTime = (?) AND id > (?)",params:[a.lwt,a.id]}]:[{wherePart:"",params:[]}],i=[],[4,Promise.all(s.map((function(a){return t(o,void 0,void 0,(function(){var t;return e(this,(function(e){switch(e.label){case 0:return t='\n                    SELECT *\n                    FROM "'.concat(this.collectionName,'"\n                    ').concat(a.wherePart,"\n                    ORDER BY \n                        lastWriteTime ASC,\n                        id ASC\n                    LIMIT ").concat(n,"\n                    ;\n                "),[4,this.sqliteBasics.all(this.internals.database,{query:t,params:a.params})];case 1:return e.sent().forEach((function(t){i.push(JSON.parse(t.data))})),[2]}}))}))})))];case 1:return u.sent(),i=(i=r(this.primaryPath,i)).slice(0,n),c=l(i),[2,{documents:i,checkpoint:c?{id:c[this.primaryPath],lwt:c._meta.lwt}:a||{id:"",lwt:0}}]}}))}))},s.prototype.changeStream=function(){return this.changes$.asObservable()},s.prototype.cleanup=function(n){return t(this,void 0,void 0,(function(){var t;return e(this,(function(e){switch(e.label){case 0:return t=(new Date).getTime()-n,[4,this.sqliteBasics.all(this.internals.database,{query:'\n                    DELETE FROM\n                        "'.concat(this.collectionName,'"\n                    WHERE\n                        deleted = 1\n                        AND\n                        lastWriteTime < ?\n                '),params:[t]})];case 1:return e.sent(),[2,!0]}}))}))},s.prototype.remove=function(){return t(this,void 0,void 0,(function(){var t;return e(this,(function(e){switch(e.label){case 0:return t=[this.sqliteBasics.run(this.internals.database,{query:'DROP TABLE IF EXISTS "'.concat(this.collectionName,'"'),params:[]})],this.schema.attachments&&t.push(this.sqliteBasics.run(this.internals.database,{query:'DROP TABLE IF EXISTS "'.concat(this.collectionName,'_attachments"'),params:[]})),[4,Promise.all(t)];case 1:return e.sent(),[2,this.close()]}}))}))},s.prototype.getAttachmentData=function(n,a){return t(this,void 0,void 0,(function(){var t;return e(this,(function(e){switch(e.label){case 0:return t='\n        SELECT data\n        FROM "'.concat(this.collectionName,'_attachments"\n        WHERE\n            docIdWithAttachmentId = ?\n        LIMIT 1\n        ;'),[4,this.sqliteBasics.all(this.internals.database,{query:t,params:[p(n,a)]})];case 1:return[2,e.sent()[0].data]}}))}))},s.prototype.close=function(){return t(this,void 0,void 0,(function(){return e(this,(function(t){if(this.closed)throw new Error("Cannot close already closed database "+this.databaseName+"-"+this.collectionName);return this.closed=!0,this.changes$.complete(),[2,f(this.databaseName,this.storage.settings.sqliteBasics)]}))}))},s.prototype.conflictResultionTasks=function(){return(new m).asObservable()},s.prototype.resolveConflictResultionTask=function(t){return o},s}();export{q as RxStorageInstanceSQLite};export function createSQLiteStorageInstance(n,a,i){return t(this,void 0,void 0,(function(){var r,o,u,l=this;return e(this,(function(h){switch(h.label){case 0:return[4,E(n.settings.sqliteBasics,a.databaseName).then((function(n){return t(l,void 0,void 0,(function(){var r,c,o=this;return e(this,(function(u){switch(u.label){case 0:return r=i.sqliteBasics,c=[],""!==r.journalMode&&c.push(r.run(n,{query:"pragma journal_mode = ".concat(r,";"),params:[]})),[4,b(n,r,(function(){return t(o,void 0,void 0,(function(){return e(this,(function(t){switch(t.label){case 0:return c.push(r.run(n,{query:'\n                            CREATE TABLE IF NOT EXISTS "'.concat(a.collectionName,'"(\n                                id TEXT NOT NULL PRIMARY KEY,\n                                revision TEXT,\n                                deleted BOOLEAN NOT NULL CHECK (deleted IN (0, 1)),\n                                lastWriteTime INTEGER NOT NULL,\n                                data json\n                            );\n                        '),params:[]})),a.schema.attachments&&c.push(r.run(n,{query:'\n                                    CREATE TABLE IF NOT EXISTS "'.concat(a.collectionName,'_attachments"(\n                                        docIdWithAttachmentId TEXT NOT NULL PRIMARY KEY,\n                                        digest TEXT NOT NULL,\n                                        length INTEGER NOT NULL,\n                                        type TEXT NOT NULL,\n                                        data BLOB\n                                    );\n                                '),params:[]})),[4,Promise.all(c)];case 1:return t.sent(),[2,"COMMIT"]}}))}))}),{indexCreation:!1,databaseName:a.databaseName,collectionName:a.collectionName})];case 1:return u.sent(),[4,b(n,r,(function(){return t(o,void 0,void 0,(function(){var t;return e(this,(function(e){switch(e.label){case 0:return(t=a.schema.indexes?a.schema.indexes.map((function(t){return s(t)?t:[t]})):[]).push(["deleted","lastWriteTime"]),t.push(["lastWriteTime","id"]),[4,Promise.all(t.map((function(t){var e=s(t)?t:[t],i=y(e),c=e.map((function(t){return"JSON_EXTRACT(data, '$."+t+"')"}));c.push("deleted");var o='CREATE INDEX IF NOT EXISTS "'+i+'" ON "'+a.collectionName+'"('+c.join(", ")+");";return r.run(n,{query:o,params:[]})})))];case 1:return e.sent(),[2,"COMMIT"]}}))}))}),{indexCreation:!0,databaseName:a.databaseName,collectionName:a.collectionName})];case 2:return u.sent(),[2,n]}}))}))}))];case 1:return r=h.sent(),o={database:r},u=new q(n,a.databaseName,a.collectionName,a.schema,o,a.options,i),c(T,a,u),[2,u]}}))}))}