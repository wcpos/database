import{getStartIndexStringFromLowerBound as e,getStartIndexStringFromUpperBound as t,lastOfArray as n,getQueryMatcher as a,getSortComparator as r}from"rxdb";import{TRANSACTION_SETTINGS as i}from"./indexeddb-helpers";import{getIndexId as s}from"./indexeddb-index-helpers";export async function queryIndexedDB(n,o){var c=o.queryPlan,d=o.query,l=d.skip?d.skip:0,u=l+(d.limit?d.limit:1/0),m=n.internals.storeNames.documentStore,v=n.settings.batchSize?n.settings.batchSize:50,y=!1;c.selectorSatisfiedByIndex||(y=a(n.schema,d));var g=c.index,h=!c.sortFieldsSameAsIndexFields,f=["_deleted"].concat(g),p=c.startKeys;p=[!1].concat(p);var x=e(n.schema,f,p,c.inclusiveStart),S=c.endKeys;S=[!1].concat(S);var I,B,b=t(n.schema,f,S,c.inclusiveEnd),P=[],w=(await n.internals.state.creationPromise).transaction([m],"readonly",i),K=w.objectStore(m);B=1===g.length&&g[0]===n.primaryPath?s(n.internals,["_deleted",n.primaryPath]):s(n.internals,f),I=K.index(B);var D=!1;if(await runBatchedCursor(n,c,I,v,x,b,B,(e=>(e.forEach((e=>{D||y&&!y(e)||P.push(e),h||P.length!==u||(D=!0)})),!D))),w.commit&&w.commit(),h){var E=r(n.schema,d);P=P.sort(E)}return{documents:P=P.slice(l,u)}}export async function runBatchedCursor(e,t,a,r,i,s,o,c){var d=e.settings.IDBKeyRange?e.settings.IDBKeyRange:IDBKeyRange,l=e.internals.getIndexableStringByIndexId[o];if("function"==typeof a.getAll&&1!==r)for(var u,m=!0,v=!1,y=async function(){u&&(i=l(u.d));var e=d.bound(i,s,!m||!t.inclusiveStart,!t.inclusiveEnd);m=!1;var o=a.getAll(e,r);await new Promise(((e,t)=>{o.onerror=t,o.onsuccess=t=>{var a=t.target.result;(u=n(a),0!==a.length)&&(!1===c(a.map((e=>e.d)))&&(v=!0));a.length<r&&(v=!0),e()}}))};!1===v;)await y();else{var g=d.bound(i,s,!t.inclusiveStart,!t.inclusiveEnd),h=a.openCursor(g);await new Promise((e=>{h.onsuccess=function(t){var n=t.target.result;if(n){var a=n.value;c([a.d])?n.continue():e()}else e()}}))}}export async function countIndexedDB(n,a){var r=a.queryPlan,o=n.internals.storeNames.documentStore,c=r.index,d=["_deleted"].concat(c),l=r.startKeys;l=[!1].concat(l);var u=e(n.schema,d,l,r.inclusiveStart),m=r.endKeys;m=[!1].concat(m);var v,y,g=t(n.schema,d,m,r.inclusiveEnd),h=(await n.internals.state.creationPromise).transaction([o],"readonly",i).objectStore(o);y=1===c.length&&c[0]===n.primaryPath?s(n.internals,["_deleted",n.primaryPath]):s(n.internals,d),v=h.index(y);var f=(n.settings.IDBKeyRange?n.settings.IDBKeyRange:IDBKeyRange).bound(u,g,!r.inclusiveStart,!r.inclusiveEnd),p=v.count(f);return{count:await new Promise(((e,t)=>{p.onsuccess=function(){e(p.result)},p.onerror=t})),mode:"fast"}}