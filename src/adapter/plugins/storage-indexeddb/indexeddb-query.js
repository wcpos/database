import{getStartIndexStringFromLowerBound as e,getStartIndexStringFromUpperBound as t,lastOfArray as n}from"rxdb";import{RxStorageIndexedDBStatics as r,TRANSACTION_SETTINGS as a}from"./indexeddb-helpers";import{getIndexId as i}from"./indexeddb-index-helpers";export async function queryIndexedDB(n,s){var o=s.queryPlan,c=s.query,d=c.skip?c.skip:0,l=d+(c.limit?c.limit:1/0),u=n.internals.storeNames.documentStore,m=n.settings.batchSize?n.settings.batchSize:50,v=!1;o.selectorSatisfiedByIndex||(v=r.getQueryMatcher(n.schema,s));var y=o.index,g=!o.sortFieldsSameAsIndexFields,h=["_deleted"].concat(y),p=o.startKeys;p=[!1].concat(p);var f=e(n.schema,h,p,o.inclusiveStart),x=o.endKeys;x=[!1].concat(x);var S,I,B=t(n.schema,h,x,o.inclusiveEnd),b=[],P=(await n.internals.state.creationPromise).transaction([u],"readonly",a),w=P.objectStore(u);I=1===y.length&&y[0]===n.primaryPath?i(n.internals,["_deleted",n.primaryPath]):i(n.internals,h),S=w.index(I);var K=!1;if(await runBatchedCursor(n,o,S,m,f,B,I,(e=>(e.forEach((e=>{K||v&&!v(e)||b.push(e),g||b.length!==l||(K=!0)})),!K))),P.commit&&P.commit(),g){var D=r.getSortComparator(n.schema,s);b=b.sort(D)}return{documents:b=b.slice(d,l)}}export async function runBatchedCursor(e,t,r,a,i,s,o,c){var d=e.settings.IDBKeyRange?e.settings.IDBKeyRange:IDBKeyRange,l=e.internals.getIndexableStringByIndexId[o];if("function"==typeof r.getAll&&1!==a)for(var u,m=!0,v=!1,y=async function(){u&&(i=l(u.d));var e=d.bound(i,s,!m||!t.inclusiveStart,!t.inclusiveEnd);m=!1;var o=r.getAll(e,a);await new Promise(((e,t)=>{o.onerror=t,o.onsuccess=t=>{var r=t.target.result;(u=n(r),0!==r.length)&&(!1===c(r.map((e=>e.d)))&&(v=!0));r.length<a&&(v=!0),e()}}))};!1===v;)await y();else{var g=d.bound(i,s,!t.inclusiveStart,!t.inclusiveEnd),h=r.openCursor(g);await new Promise((e=>{h.onsuccess=function(t){var n=t.target.result;if(n){var r=n.value;c([r.d])?n.continue():e()}else e()}}))}}export async function countIndexedDB(n,r){var s=r.queryPlan,o=n.internals.storeNames.documentStore,c=s.index,d=["_deleted"].concat(c),l=s.startKeys;l=[!1].concat(l);var u=e(n.schema,d,l,s.inclusiveStart),m=s.endKeys;m=[!1].concat(m);var v,y,g=t(n.schema,d,m,s.inclusiveEnd),h=(await n.internals.state.creationPromise).transaction([o],"readonly",a).objectStore(o);y=1===c.length&&c[0]===n.primaryPath?i(n.internals,["_deleted",n.primaryPath]):i(n.internals,d),v=h.index(y);var p=(n.settings.IDBKeyRange?n.settings.IDBKeyRange:IDBKeyRange).bound(u,g,!s.inclusiveStart,!s.inclusiveEnd),f=v.count(p);return{count:await new Promise(((e,t)=>{f.onsuccess=function(){e(f.result)},f.onerror=t})),mode:"fast"}}