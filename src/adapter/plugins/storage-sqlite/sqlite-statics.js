import{clone as r,DEFAULT_CHECKPOINT_SCHEMA as e,randomCouchString as t,getDefaultSortComparator as o,RxStorageDefaultStatics as a,getPrimaryFieldOfPrimaryKey as n}from"rxdb";import{getIndexId as u,getJsonExtract as p,isPlainObject as s}from"./sqlite-helpers";export var RxStorageSQLiteStatics={prepareQuery(e,t){var o=n(e.primaryKey),a=t.limit?"LIMIT "+t.limit:"LIMIT -1",p=t.skip?"OFFSET "+t.skip:"",s=[],i="",c=void 0,m="";t.index&&(m='INDEXED BY "'+u(t.index)+'"');var l=mangoQuerySortToSQL(o,t.sort);try{var h=mangoQuerySelectorToSQL(e,t.selector,s);i=m+" WHERE deleted=0 "+(h="()"!==h?" AND "+h+" ":"")+l+" "+a+" "+p+" ;"}catch(r){if(!r.isNonImplementedOperatorError)throw r;c=r.operator,i=m+" WHERE deleted=0 "+l+" LIMIT 50 "}return{schema:e,mangoQuery:r(t),sqlQuery:{query:i,params:s},queryWithoutSort:i.replace(l," "),nonImplementedOperator:c}},getSortComparator:(r,e)=>o(r,e.mangoQuery),getQueryMatcher:(r,e)=>a.getQueryMatcher(r,{query:e.mangoQuery}),checkpointSchema:e};var i=["$or","$and"];export function mangoQuerySelectorToSQL(r,e,o,a){var u=n(r.primaryKey);return"("+Object.entries(e).map((([e,n])=>{if(!e.startsWith("$")){if(s(n))return mangoQuerySelectorToSQL(r,n,o,e);var c="?";return o.push(n),p(u,e)+"="+c}if(i.includes(e)){var m=e.substring(1).toUpperCase();return n.map((e=>mangoQuerySelectorToSQL(r,e,o,a))).join(" "+m+" ")}if(!a)throw new Error("cannot have selector operator on the top level "+e);var l="?";switch(e){case"$eq":return null===n?p(u,a)+" IS NULL":(o.push(n),p(u,a)+"="+l);case"$ne":return null===n?p(u,a)+" IS NOT NULL":(o.push(n),p(u,a)+"!="+l);case"$gt":return o.push(n),p(u,a)+">"+l;case"$gte":return o.push(n),p(u,a)+">="+l;case"$lt":return o.push(n),p(u,a)+"<"+l;case"$lte":return o.push(n),p(u,a)+"<="+l;case"$exists":return n?(o.push("rand-"+t(10)),p(u,a)+"!="+l):p(u,a)+" IS NULL";case"$in":return n.forEach((r=>o.push(r))),p(u,a)+" IN ("+new Array(n.length).fill(l).join(",")+")";case"$nin":return o.push(n),p(u,a)+" NOT IN ("+l+")";default:var h=new Error("operator "+e+" not implemented");throw h.operator=e,h.isNonImplementedOperatorError=!0,h}})).join(" AND ")+")"}export function mangoQuerySortToSQL(r,e){return"ORDER BY "+e.map((e=>{var[t,o]=Object.entries(e)[0];return p(r,t)+" "+o.toUpperCase()})).join(", ")}